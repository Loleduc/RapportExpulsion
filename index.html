<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Rapport d'expulsion</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css"> 	

<style>
/* -----------------------------------------------------------------------------------
 * CSS G√âN√âRAL (AJUST√â: INPUT PADDING √Ä 8PX POUR UNE MEILLEURE HAUTEUR)
 * ----------------------------------------------------------------------------------- */
 body { 
    font-family: Arial, sans-serif; 
    padding: 20px; 
    /* üõë CORRECTION CL√â : D√©grad√© de Pantone 282 C (#00255c) √† 285 C (#0073e6) */
  /*  background: linear-gradient(to bottom, #00255c 0%, #0073e6 100%); */
	background: linear-gradient(to bottom, #0073e6 00%,  #00255c 100%);
    /* Le d√©grad√© se fait sur toute la page, mais vous pouvez aussi le forcer sur 100vh */
    min-height: 100vh;
    
    /* üõë Ancien background-color: #f4f4f4; est remplac√© par le d√©grad√© ci-dessus. */
}
h1 { 
	font-size: 72px;
    text-align: center; 
    /* üõë CORRECTION CL√â : Couleur du texte chang√©e √† blanc */
    color: white; 
    /* color: #ffffff; fonctionnerait aussi */
    /* Vous pouvez aussi ajouter un peu de marge si vous trouvez que le titre est trop pr√®s du bord */
    margin-bottom: 25px; 
	text-shadow: 
        /* Ombre l√©g√®re pour la profondeur (plus proche) */
        2px 2px 0px #0056b3, 
        /* Ombre plus fonc√©e pour la distance (plus loin) */
        4px 4px 0px #00255c, 
        /* Ombre la plus √©loign√©e pour l'effet de projection */
        6px 6px 5px rgba(0, 0, 0, 0.5); 
}
h2 { font-size: 30px;  margin-top: 10px; margin-bottom: 25px; color : dimgrey; 
	text-shadow: 
        /* Ombre l√©g√®re pour la profondeur (plus proche) */
        2px 2px 0px #000, 
        /* Ombre plus fonc√©e pour la distance (plus loin) */
        4px 4px 0px #d0d3d4, 
        /* Ombre la plus √©loign√©e pour l'effet de projection */
        6px 6px 5px rgba(0, 0, 0, 0.1); }

label { display: block; margin: 8px 0 4px; font-weight: bold; }
/* Augmentation du padding des inputs √† 8px pour une meilleure visibilit√© et hauteur */
input, select, textarea { padding: 8px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }

#matchNumero { width: 140px; }
#matchDate { width: 220px; }

.match-row { display: flex; gap: 15px; align-items: flex-start; justify-content: center; } /* Centrage */
.match-row > div { display: flex; flex-direction: column; }

.select-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; } /* Centrage */
.select-row select { width: max-content; min-width: 150px; max-width: 300px; }

.match-row label, 
.select-row label {
    /* üõë CHANGEMENT CL√â 1: S'assurer que le label prend toute la place disponible pour le texte */
    text-align: center; /* Centre le texte (le libell√©) lui-m√™me */
    /* REMARQUE: Si le label est dans un <div> plus grand, cette propri√©t√© peut ne pas suffire. 
       Il faudra forcer le conteneur du label √† √™tre centr√©. */
}	
	
.match-equipes-row { display: flex; gap: 15px; align-items: flex-start; justify-content: center; } 
.match-equipes-row > div { display: flex; flex-direction: column; }
#equipeLocale, #equipeVisiteur, #terrain { width: 250px; }

.match-equipes-row label, 
.select-row label {
    /* üõë CHANGEMENT CL√â 1: S'assurer que le label prend toute la place disponible pour le texte */
    text-align: center; /* Centre le texte (le libell√©) lui-m√™me */
    /* REMARQUE: Si le label est dans un <div> plus grand, cette propri√©t√© peut ne pas suffire. 
       Il faudra forcer le conteneur du label √† √™tre centr√©. */
}	
	

.expulsion-block { padding: 10px; margin-top: 10px; border-radius: 8px; }

/* -----------------------------------------------------------------------------------
 * CHIPS ET CODES
 * ----------------------------------------------------------------------------------- */
.chips-container { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 0; justify-content: center; } 
.chip { padding: 4px 12px; border-radius: 16px; border: 1px solid #0072ce; cursor: pointer; font-size: 14px; color: #0072ce; background: #fff; text-align: center; }
.chip.selected { background: #0072ce; color: #fff; }

.codes-container { display: flex; flex-wrap: wrap; gap: 6px; justify-content:center; margin-top:10px; width: 100%; }
.code-chip {
  position: relative;
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid #0072ce;
  cursor: pointer;
  font-size: 13px;
  color: #0072ce;
  margin-bottom: 4px;
  width: 48%; /* Deux chips par ligne */
  box-sizing: border-box;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  background: #fff;
  transition: all 0.2s;
}

.code-chip.selected {
  background: #0072ce;
  color: #fff;
  font-weight: bold;
}

.code-chip .tooltip {
  visibility: hidden;
  width: 300px;
  background-color: #333;
  color: #fff;
  text-align: left;
  padding: 10px;
  border-radius: 6px;
  position: absolute;
  z-index: 100;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  white-space: pre-line;
  font-size: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.code-chip:hover .tooltip {
  visibility: visible;
  opacity: 1;
}
	

/* -----------------------------------------------------------------------------------
 * ERREURS ET BOUTONS
 * ----------------------------------------------------------------------------------- */
.error { color: #d93025; font-size: 12px; font-weight: 600; margin-bottom: 6px; display: block; min-height: 16px; }

button[type="submit"], button[type="reset"] { background:#007BFF; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px; margin-right: 10px; }
button:hover { background:#0056b3; }

#details, #infos_complementaires { width: 100%; resize: vertical; min-height: 80px; padding: 8px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; overflow: hidden; }

/* -----------------------------------------------------------------------------------
 * STRUCTURES COMPLEXES (Arbitres, Expulsions)
 * ----------------------------------------------------------------------------------- */
.arbitres-coordonnees-container { 
    display: flex; 
    gap: 15px; 
    justify-content: center; 
    align-items: flex-start; 
    flex-wrap: wrap; 
    width: 100%; 
}

.arbitres-col { 
    display: flex; 
    flex-direction: column; 
    /* Rapprochement vertical : 5px de gap (r√©duit de 10px) */
    gap: 5px; 
    /* Forcer la colonne √† ne pas s'√©tirer (elle est maintenant fix√©e par la largeur de l'input √† 300px) */
    flex-grow: 0; 
    /* Laisser le min-width par d√©faut pour la flexibilit√© si besoin, ou le fixer √† 300px */
    min-width: 300px; 
}

.arbitres-col .champ { 
    display: flex; 
    flex-direction: column; 
    /* üõë Assure que le label et l'input sont centr√©s (en plus du .arbitres-col) */
    align-items: center; 
}

.arbitres-col label { 
    font-weight: bold; 
    /* üõë Rapprochement vertical : r√©duire l'espace sous le label */
    margin-bottom: 2px; 
    white-space: nowrap; 
    /* üõë Centrer le texte du label */
    text-align: center; 
}

/* R√®gle pour contr√¥ler la largeur et le rapprochement de l'input */
.arbitres-col input, .arbitres-col select { 
    width: 300px; 
    box-sizing: border-box; 
}
	
.exp-row input,
.exp-row select {
    width: 100%;
}
.exp-row { 
    display: flex; 
    gap: 20px; 
    justify-content: center; 
    align-items: flex-start; 
    flex-wrap: nowrap; 
    margin-bottom: 15px;
}

/* üõë NOUVEAU: D√©finition individuelle des largeurs des champs d'expulsion (flex: 0 0 <largeur>) */
/* Ceci remplace l'ancien bloc .exp-equipe, .exp-numero, .exp-nom */
.exp-equipe { 
    flex: 0 0 250px; /* Largeur de 250px pour le s√©lecteur d'√©quipe */
}
.exp-numero { 
    flex: 0 0 75px; /* Largeur de 100px pour le num√©ro du joueur */
}
.exp-nom { 
    flex: 0 0 250px; /* Largeur de 350px pour le nom du joueur */
}

/* Centrage des labels au-dessus des inputs d'expulsion */
.exp-row div { 
    text-align: center; 
}
.exp-row label {
     text-align: center; 
}

/* En-t√™te Expulsion (alignement) */
/* üõë NOUVELLE R√àGLE : Empile titre et chips verticalement et les centre */
.expulsion-header-row {
    display: flex;
    flex-direction: column; /* üõë CHANGEMENT CL√â ICI */
    align-items: center;
    gap :; 
    width: 100%;
    margin-bottom: 5px;
    padding-bottom: 0px;
    border-bottom: 1px solid #eee;
    justify-content: center; /* Gard√© pour la compatibilit√©, mais moins critique avec flex-direction: column */
}

/* R√®gle pour s'assurer que le h2 s'adapte au nouveau conteneur */
.expulsion-header-row h2 {
    font-size: 1.2em;
    font-weight: bold;
    margin: 0;
    white-space: nowrap;
    color: #333;
	text-align: center; /* S'assure que le texte du titre est centr√© */
}

/* R√®gle pour que le conteneur des chips puisse s'√©tendre (et que les chips y soient centr√©es) */
.expulsion-header-row .chips-container {
    margin: 0;
    justify-content: center; 
    width: 100%; 
   
}
	.expulsion-header-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0px; /* R√©duit le gap entre le titre et les chips s'ils √©taient dedans */
    width: 100%;
    margin-bottom: 15px; /* ‚¨ÖÔ∏è Espace r√©duit sous le titre */
    padding-bottom: 2px; /* ‚¨ÖÔ∏è Espace r√©duit au-dessus du trait de s√©paration */
    border-bottom: 0px solid #eee;
    justify-content: center;
}

/* Onglets expulsions */
.tabs { display: flex; gap: 5px; margin-top: 20px; margin-bottom: 15px; flex-wrap: wrap; justify-content:center; width: 100%; }
.tabs button { padding: 6px 12px; cursor:pointer; border-radius:6px; border:1px solid #0072ce; background:#fff; color:#0072ce; font-size:14px; transition: all 0.2s; }
.tabs button.active { background:#0072ce; color:#fff; font-weight: bold; }
.tab-content { display: none; width:100%; }
.tab-content.active { display: block; }

/* Panels 3D (Design) */
.panel-3d, .panel-3d-detail, .panel-3d-info { 
    border: 1px solid #ccc; 
    border-radius: 10px; 
    padding: 20px; 
    
    /* üõë CHANGEMENT CL√â 1: Utiliser "auto" pour centrer le panneau horizontalement */
    margin: 20px auto; 
    
    background : #d0d3d4;
    
	 /* üõë AJOUT CL√â POUR L'EFFET 3D (Ombres) */
    box-shadow: 
        /* Ombre interne claire (simule la lumi√®re venant du haut) */
        inset 0 3px 0 rgba(255, 255, 255, 0.7), 
        /* Ombre interne fonc√©e (simule la profondeur, le 'creux') */
        inset 0 -3px 0 rgba(0, 0, 0, 0.1),
        /* Ombre externe subtile (simule l'√©l√©vation du panneau) */
        0 8px 6px rgba(0, 0, 0, 0.5); 
	
	display: flex; 
    flex-direction: column; 
    align-items: flex-start; 
    
    /* üõë CHANGEMENT CL√â 2: D√©finir une largeur maximale (ou fixe) */
    width: 95%; /* Marge de s√©curit√© pour petits √©crans */
    max-width: 1100px; /* C'est la largeur r√©elle que le panneau ne d√©passera pas. Ajustez cette valeur. */
    
    box-sizing: border-box; 
}
/* La r√®gle suivante assure que les √©l√©ments (les champs) √† l'int√©rieur de .panel-3d restent centr√©s, m√™me si le panneau est plus √©troit que la page. */
.panel-3d { 
    align-items: center; 
}

.panel-3d h2, 
.panel-3d-detail h2, /* AJOUT√â */
.panel-3d-info h2 { /* AJOUT√â */
    font-size: 30px; 
    margin-top: 10px; 
    margin-bottom: 25px; 
    color : dimgrey; /* (Exemple : Bleu fonc√© pour une coh√©rence) */
    text-shadow: 
        2px 2px 0px rgba(255, 255, 255, 0.5), 
        3px 3px 2px rgba(0, 0, 0, 0.2); 
}


.input-error, .input-error:focus {
  border: 2px solid #d93025 !important;
  /* Red "halo" effect */
  box-shadow: 0 0 8px  rgba(217, 48, 37, 0.4);
}
	
	
#destinatairesContainer label,
#destinataires,
#debugContainer h2,
#debugOutput {
    color: white !important; /* Force la couleur pour le texte du debug et des destinataires */
}

</style>
</head>
<body>

<h1>RAPPORT D'EXPULSION 22:57</h1>

<form id="rapportForm" novalidate>

<div class="panel-3d panel-step">
 <h2>Informations sur le match</h2>
  <div class="match-row">
    <div><label># Match</label><input type="text" id="matchNumero" name="numero" maxlength="12" tabindex="1" required><div class="error"></div></div>
    <div><label>Date et Heure du match</label><input type="text" id="matchDate" name="date" tabindex="2" required ><div class="error"></div></div>
  </div>

  <div class="select-row">
    <div><label>R√©gion</label><select id="regionSelect" tabindex="3" required><option value="">-- S√©lectionner une r√©gion --</option></select><div class="error"></div></div>
    <div><label>Ligue</label><select id="ligueSelect" tabindex="4" required><option value="">-- S√©lectionner une ligue --</option></select><div class="error"></div></div>
    <div><label>Cat√©gorie</label><select id="categorieSelect" tabindex="5" required><option value="">-- S√©lectionner une cat√©gorie --</option></select><div class="error"></div></div>
    <div><label>Classe</label><select id="classeSelect" tabindex="6" required><option value="">-- S√©lectionner une classe --</option></select><div class="error"></div></div>
  </div>
</div>

<div class="panel-3d panel-step">
 <h2>√âquipes et terrain</h2>
    <div class="match-equipes-row">
  <div>
    <label>√âquipe locale</label>
    <input type="text" id="equipeLocale" list="equipesDataList" tabindex="7" required>
    <div class="error"></div>
  </div>
  <div>
    <label>√âquipe visiteur</label>
    <input type="text" id="equipeVisiteur" list="equipesDataList" tabindex="8" required>
    <div class="error"></div>
  </div>
  <div><label>Terrain</label><input type="text" name="terrain" id="terrain" tabindex="9" required><div class="error"></div></div>
</div>

<datalist id="equipesDataList"></datalist>
</div>

<div class="panel-3d arbitres-panel panel-step">
  <h2>Arbitres et Coordonn√©es</h2>
  <div class="arbitres-coordonnees-container">
    <div class="arbitres-col">
      <div class="champ">
        <label for="arbitreMarbre">Arbitre au marbre</label>
        <input type="text" id="arbitreMarbre" tabindex="10" required>
        <div class="error"></div>
      </div>
      <div class="champ">
        <label for="arbitreRapport">Arbitre faisant le rapport</label>
        <select id="arbitreRapport" disabled tabindex="13" required>
          <option value="">-- S√©lectionner un arbitre --</option>
        </select>
        <div class="error"></div>
      </div>
    </div>

    <div class="arbitres-col">
      <div class="champ">
        <label for="arbitreButs">Arbitre sur les buts</label>
        <input type="text" id="arbitreButs" tabindex="11" required>
        <div class="error"></div>
      </div>
      <div class="champ">
        <label for="courriel">Adresse courriel</label>
        <input type="email" id="courriel" tabindex="14" required>
        <div class="error"></div>
      </div>
    </div>

    <div class="arbitres-col">
      <div class="champ">
        <label for="marqueur">Marqueur</label>
        <input type="text" id="marqueur" tabindex="12" required>
        <div class="error"></div>
      </div>
      <div class="champ">
        <label for="telephone">T√©l√©phone</label>
        <input type="tel" id="telephone" required tabindex="15" placeholder="(000) 000-0000" > 
        <div class="error"></div>
      </div>
    </div>
  </div>
</div>

<div class="panel-3d panel-step" id="expulsionsPanel">
    <div class="expulsion-header-row">
        <h2>Nombre d'expulsions :</h2>
        
    </div>
    <div class="chips-container" id="chipsNbExp"></div> 
    
	<div class="tabs" id="expTabs"></div>
    <div id="expulsionsContainer"></div>
</div>
   

	
<div class="panel-3d-detail panel-step" >
  <h2>D√©tails concernant les expulsions</h2>
  <textarea name="details" id="details" required></textarea>
</div>

<div class="panel-3d-info panel-step">
  <h2>Informations compl√©mentaires</h2>
  <textarea name="infos_complementaires" id="infos_complementaires"></textarea>
</div>

<div style="margin-top: 20px; text-align: center;">
    <button type="submit">Envoyer le rapport</button>
    <button type="reset" id="effacerBtn">Effacer le rapport</button>
</div>
	
</form>

 <div id="destinatairesContainer" style="color: white; display: none;">
  <div style="font-size: 1.5em; font-weight: bold; margin-top: 10px; margin-bottom: 25px;">
    <label>Destinataires</label>
    <div id="destinataires" style="font-style: italic; color: white;"></div>
  </div>
	
	
<div id="debugContainer" style="color: white; display: none;">
  <div style="font-size: 1.5em; font-weight: bold; margin-top: 10px; margin-bottom: 25px;">
     Debug JSON
  </div>   <pre id="debugOutput" style="color: white;"></pre>
</div>
</div>	
	
	
	
	
	
	
<script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.2/imask.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script> 
<script>
/*const regionUrl = "https://script.google.com/macros/s/AKfycby5mjKpMvPhV4jQdNPuO7H8NIcaRh_P3SRoqQSJLu8IzrMn7s5ytmZxbYXody-nqVKS-A/exec";
const codesUrl = "https://script.google.com/macros/s/AKfycbxTNlQ5JFpIDIBSTWARTT3v1ztYXexP9zMuVwwAdWC43acGQGA1cPibQYqSyCabhzEd/exec";¬†
*/
const regionUrl = https://raw.githubusercontent.com/Loleduc/RapportExpulsion/refs/heads/main/BETA%20adressesmultiples.json
const codesUrl = https://raw.githubusercontent.com/Loleduc/RapportExpulsion/refs/heads/main/Codes.json


let jsonRegions = {}, currentLigueData = {};
let jsonCodes = {}; // Sera rempli par l'appel √† codesUrl
let expulsionsData = {}; // üõë Objet pour stocker les donn√©es de chaque expulsion (persistance)
let ObjetCourriel ="";

const destinatairesContainer = document.getElementById("destinatairesContainer");
const destinatairesDiv = document.getElementById("destinataires");

// üõë S√âPARATEUR UNIQUE ET S√õR pour la persistance
const CODE_SEPARATOR = '||';


// -------------------------------------------------------------
// SECTION: LOGIQUE DE G√âN√âRATION DU RAPPORT HTML (Client-Side JS)
// -------------------------------------------------------------

// ====================================================================
// A. FONCTIONS D'ASSISTANCE (Simulation des services App Script)
// ====================================================================

// üõë NOUVEAU: ID de votre logo Google Drive
const LOGO_DRIVE_ID = "1Kqf-zlSqbQO-gdp7vrqedi4lhZG-UwDC";

/**
 * Retourne l'URL de t√©l√©chargement direct du logo.
 * NOTE : Cette m√©thode n√©cessite que le fichier Drive soit public et qu'une connexion Internet soit active.
 * @returns {string} URL directe de l'image.
 */
function getLogoUrl() {
    return `https://drive.google.com/uc?export=download&id=${LOGO_DRIVE_ID}`;
}

async function chargerDonneesDepuisGitHub(url) {
    try {
        const reponse = await fetch(url, {
            // Pas besoin de headers ni de mode: 'no-cors'
            method: 'GET'
        });

        // üîë Le statut 200 doit √™tre l√†
        if (!reponse.ok) {
            throw new Error(`Erreur HTTP: ${reponse.status}`);
        }

        // üîë Le navigateur peut lire le JSON directement et sans erreur
        return await reponse.json(); 
        
    } catch (erreur) {
        console.error("Erreur lors du chargement des donn√©es depuis GitHub:", erreur);
        return null; 
    }
}

/**
 * Remplace l'ancienne fonction "convertirImageEnBase64" pour utiliser l'URL directe.
 */
function convertirImageEnBase64(imageName) {
    return getLogoUrl();
}

/**
 * Retourne la date et l'heure courante format√©e.
 */
function getCurrentDateTime() {
    return new Date().toLocaleString('fr-FR', {
        day: '2-digit', month: 'long', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    }).replace('√†', '');
}
function delaiEntreDates(dateMatch, dateRapport) { return ""; }
function separerEnTableau(text) { return text ? text.split('\n').map(s => s.trim()).filter(s => s.length > 0) : []; }
function determinedestinataire() { return document.getElementById("destinataires")?.textContent || "N/A"; }

// ====================================================================
// B. TRANSFORMATION DES DONN√âES (JSON de Debug -> Tableau Plat)
// ====================================================================

/**
 * Construit la structure de donn√©es attendue ({question, reponse}) √† partir du r√©sultat de generateDebugJSON().
 * @returns {Array<Object>} Le tableau d'objets {question, reponse} plat.
 */
function transformDebugJSONToCustomData() {
    // üõë IMPORTANT: S'assurer que les donn√©es courantes sont sauvegard√©es avant de g√©n√©rer.
    serializeCurrentExpulsion();
    
    // G√©n√©rer le JSON de donn√©es complet
    const debugData = generateDebugJSON();
    const data = [];

    // --- PARTIE FIXE (Index 0 √† 14 pour la logique switch) ---
    data.push({ question: 'Match # :', reponse: debugData.match.numero }); // 0
    data.push({ question: 'Date et Heure du match :', reponse: debugData.match.date }); // 1
    data.push({ question: 'R√©gion du Match :', reponse: debugData.match.region }); // 2
    data.push({ question: 'Ligue :', reponse: debugData.match.ligue }); // 3
    data.push({ question: 'Cat√©gorie :', reponse: debugData.match.categorie }); // 4
    data.push({ question: 'Classe :', reponse: debugData.match.classe }); // 5
    data.push({ question: '√âquipe locale :', reponse: debugData.equipes.locale }); // 6
    data.push({ question: '√âquipe visiteur :', reponse: debugData.equipes.visiteur }); // 7
    data.push({ question: 'Terrain :', reponse: debugData.equipes.terrain }); // 8
    data.push({ question: 'Arbitre au marbre :', reponse: debugData.officiels.marbre }); // 9
    data.push({ question: 'Arbitre sur les buts :', reponse: debugData.officiels.buts }); // 10
    data.push({ question: 'Marqueur :', reponse: debugData.officiels.marqueur }); // 11
    data.push({ question: 'Rapport fait par :', reponse: debugData.officiels.rapport }); // 12
    data.push({ question: 'Adresse courriel :', reponse: debugData.officiels.courriel }); // 13
    data.push({ question: 'Num√©ro de t√©l√©phone :', reponse: debugData.officiels.telephone }); // 14
    
    // --- PARTIE DYNAMIQUE (Expulsions) ---
    debugData.expulsions.forEach(exp => {
        // Ces titres DOIVENT correspondre exactement aux questions du formulaire App Script original
        data.push({ question: "Nom de l'√©quipe fautive :", reponse: exp.equipe });
        data.push({ question: "Num√©ro de chandail du fautif :", reponse: exp.chandail });
		data.push({ question: "Nom de la personne fautive :", reponse: exp.joueur });
       // data.push({ question: "Fonction (Entra√Æneur, G√©rant...)", reponse: "N/A" }); // Champ non pr√©sent dans le formulaire HTML
        data.push({ question: "Codes d'expulsion :", reponse: exp.codes.join('\n') });
      //  data.push({ question: "√Ä quelle p√©riode et √† quelle minute?", reponse: "N/A" }); // Champ non pr√©sent dans le formulaire HTML
        // Le champ "D√©tails concernant les expulsions" est global dans le HTML, nous l'ajoutons √† la fin.
    });

    // --- PARTIE FINALE (Infos Compl√©mentaires) ---
    // Les champs Oui/Non n'existent pas dans le HTML fourni, nous utilisons 'Non renseign√©' par d√©faut.
   // const getYesNoAnswer = (id) => document.getElementById(id)?.value === 'Oui' ? 'Oui' : 'Non renseign√©';
    
   // data.push({ question: "Le participant a-t-il re√ßu un avertissement avant d‚Äô√™tre expuls√©‚Äâ?", reponse: getYesNoAnswer('avertissement') });
   // data.push({ question: "La situation √©tait-elle d‚Äôune longue dur√©e‚Äâ?", reponse: getYesNoAnswer('duree') });
   // data.push({ question: "Une fois le terrain quitt√© par le participant, a-t-il quitt√© les environs du terrain et est-il rest√© invisible‚Äâ?", reponse: getYesNoAnswer('environs') });

    // Les deux textareas globaux (seront trouv√©s par leur titre dans la logique HTML)
    data.push({ question: "D√©tails concernant les expulsions durant le match :", reponse: debugData.match.details_expulsions });
    data.push({ question: "Informations compl√©mentaires :", reponse: debugData.match.infos_complementaires });
    
    return data;
}

// ====================================================================
// C. G√âN√âRATION DU RAPPORT HTML (Votre code App Script adapt√©)
// ====================================================================

/**
 * G√©n√®re le contenu HTML du rapport en utilisant la structure et le style App Script.
 * @param {Array<Object>} customData Le tableau de donn√©es du formulaire.
 * @returns {string} Le contenu HTML complet du rapport.
 */
async function convertirenPDF(customData) {
    const htmlContent = genererRapportExpulsion(customData);
  
    const pdfUrl = "https://script.google.com/macros/s/AKfycbxpDzlvVRMJTDSF6AGndnMnAwWQK70kqA8fi4qzUgW0bkvSQe-2cX2IZrq0TGjbpstn/exec";
    
    try {
        const response = await fetch(pdfUrl, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                htmlContent: htmlContent,
                formDataJSON: customData
            })
        });

        const data = await response.json();

        if (data.success) {
            console.log("‚úÖ PDF g√©n√©r√© :", data.pdfUrl);
            window.open(data.pdfUrl, "_blank");
        } else {
            alert("Erreur Apps Script: " + (data.error || "Raison inconnue."));
        }

    } catch (err) {
        alert("Erreur de soumission du rapport: " + err.message);
    }
}

	
	
	
function genererRapportExpulsion(customData) {
    let message = "";
    let courrierArbitre = "";
	
    
    // üé® Styles centralis√©s (Variables r√©int√©gr√©es en cha√Ænes CSS)
    const styleTable = "width: 100%; max-width: 900px; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 14px; margin: 0 auto; border: 1px solid #ddd;";
    const styleHeaderCell = "padding: 10px; text-align: left; font-size: 16px; border-top: 1px solid #ddd;";
    const styleCell = "padding: 8px; border: 1px solid #ddd; width: auto;";
    const styleCell15 = "padding: 8px; border: 1px solid #ddd; width: 15%;";
    const styleCell25 = "padding: 8px; border: 1px solid #ddd; width: 25%;";
    const styleCell30 = "padding: 8px; border: 1px solid #ddd; width: 30%;";
    const styleCell40 = "padding: 8px; border: 1px solid #ddd; width: 40%;";
    const styleTitleRow = "background-color: #f2f2f2; -webkit-print-color-adjust: exact;";

    // R√©cup√©ration des donn√©es cl√©s (avec v√©rification d'existence)
    const region = (customData[2] && customData[2].reponse) ? customData[2].reponse.toUpperCase() : "R√âGION IND√âTERMIN√âE";
    const numeroMatch = (customData[0] && customData[0].reponse) ? customData[0].reponse : "N/A";

    const image1 = convertirImageEnBase64("BQ");
    const image2 = convertirImageEnBase64("BQ"); 

    let journee = getCurrentDateTime();
    let delaisheure = delaiEntreDates(customData[1].reponse, journee);

    if (delaisheure) {
        message += `
            <div style="font-family: 'Segoe UI', sans-serif; font-size: 18px; color: red; font-weight: bold;">
                ${delaisheure}
            </div>
            <br>
        `;
    }

    // D√©but du corps HTML
    message += `<div style="font-family: 'Segoe UI', sans-serif; font-size: 15px;">`;
    message += `<table style="${styleTable}">`;

    // üîπ Bandeau du titre
    message += `
        <tr>
          
            <td style="width: 15%; text-align: center; padding: 10px; background-color:#a3a3a3; -webkit-print-color-adjust: exact;">
                <img src="${image1}" alt=" " style="max-height: 60px;">
            </td>
            <td colspan="3" style="padding: 10px; text-align: center; vertical-align: middle; color: white; background-color:#a3a3a3; -webkit-print-color-adjust: exact;">
                <div style="font-size: 26px; font-weight: bold;">(${region}) Rapport d'expulsion</div>
                <div style="font-size: 26px; margin-top: 5px;">Match # ${numeroMatch}</div>
            </td>
            <td style="width: 15%; text-align: center; padding: 10px; background-color:#a3a3a3; -webkit-print-color-adjust: exact;">
                <img src="${image2}" alt=" " style="max-height: 60px;">
            </td>
         
        </tr>
    `;

    // üß© Sections fixes (Jusqu'√† l'index 14)
    for (let i = 0; i < 15; i++) {
        if (!customData[i]) continue;

        let question = customData[i].question;
        let answer = customData[i].reponse;

        switch (i) {
            case 0: break;
            case 1: 
					if (!customData[2]) break;
    				const displayDate = (answer || "N/A").replace('T', ' ');
                message += `
                    <tr>
                    <th colspan="5" style="${styleHeaderCell}; ${styleTitleRow}">INFORMATIONS SUR LE MATCH</th>
                    </tr>
                    <tr>
                    <td colspan="2" style="${styleCell30}"><b>${question}</b></td> 
                    <td style="${styleCell}">${displayDate}</td> <td style="${styleCell}">
					<b>${customData[2].question}</b></td>
                    <td style="${styleCell}">${customData[2].reponse}</td>
                    </tr>`;
                break;
            case 3:
                if (!customData[4] || !customData[5]) break;
                message += `
                    <tr>
                    <td colspan="3" style="${styleCell}"><b>${customData[3].question}</b> &nbsp;&nbsp;${customData[3].reponse}</td>
                    <td style="${styleCell25}"><b>${customData[4].question}</b> &nbsp;&nbsp;${customData[4].reponse}</td>
                    <td style="${styleCell25}"><b>${customData[5].question}</b> &nbsp;&nbsp;${customData[5].reponse}</td>
                    </tr>`;
                i += 2;
                break;
            case 6:
                if (!customData[7]) break;
                message += `
                    <tr>
                    <th colspan="5" style="${styleHeaderCell}; ${styleTitleRow}">√âQUIPES ET TERRAIN</th>
                    </tr>
                    <tr>
                    <td style="${styleCell15}"><b>${question}</b></td>
                    <td colspan="2" style="${styleCell}">${answer}</td>
                    <td style="${styleCell15}"><b>${customData[7].question}</b></td>
                    <td style="${styleCell}">${customData[7].reponse}</td>
                    </tr>`;
                i++;
                break;
            case 8:
                message += `
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="4" style="${styleCell}">${answer}</td>
                    </tr>`;
                break;
            case 9:
                if (!customData[10]) break;
                message += `
                    <tr>
                    <th colspan="5" style="${styleHeaderCell}; ${styleTitleRow}">OFFICIELS</th>
                    </tr>
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="2" style="${styleCell}">${answer}</td>
                    <td style="${styleCell}"><b>${customData[10].question}</b></td>
                    <td style="${styleCell}">${customData[10].reponse}</td>
                    </tr>`;
                i++;
                break;
            case 11:
                message += `
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="4" style="${styleCell}">${answer}</td>
                    </tr>`;
                break;
            case 12:
                message += `
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="2" style="${styleCell}">${answer}</td>
                    <td style="${styleCell}"><b> Date et heure du rapport : </b></td>
                    <td style="${styleCell}">${journee}</td>
                    </tr>`; 
                break;
            case 13:
                message += `
                    <tr>
                    <th colspan="5" style="${styleHeaderCell}; ${styleTitleRow}">COORDONN√âES</th>
                    </tr>
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="4" style="${styleCell}">${answer}</td>
                    </tr>`;
                courrierArbitre = answer;
                break;
            case 14:
                message += `
                    <tr>
                    <td style="${styleCell25}"><b>${question}</b></td>
                    <td colspan="4" style="${styleCell}">${answer}</td>
                    </tr>`;
                break;
        }
    }

    message += `</table><br><br>`;

    // üîÅ Expulsions et d√©tails
    let expulsionIndex = 1;
    let expulsionTable = "";
    let detailsTable = "";
    const norm = s => s ? s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[‚Äô]/g, "'").replace(/\s+/g, ' ').trim() : '';
    const getAnswerToQuestion = (q, data) => {
  if (!Array.isArray(data)) return "N/A";  // s√©curit√©
  const item = data.find(d => norm(d.question).includes(norm(q)));
  return item ? (item.reponse?.length > 0 ? item.reponse : "N/A") : "N/A";
};
    
    // D√©terminer o√π commence la section des expulsions (apr√®s l'index 14)
    let startIndex = 15;
    
    // On avance dans le tableau pour trouver la premi√®re question d'expulsion
    while(startIndex < customData.length && !norm(customData[startIndex].question).startsWith("nom de l'equipe fautive")) {
        startIndex++;
    }

    for (let i = startIndex; i < customData.length; i++) {
        let question = customData[i].question;
        let answer = customData[i].reponse;
        let titreActuel = norm(question);

        // Les r√©ponses "Oui/Non" des questions compl√©mentaires sont g√©r√©es plus tard, on les ignore ici.
        if (titreActuel.includes("avertissement") || titreActuel.includes("longue duree") || titreActuel.includes("environs")) continue; 
        
        if (!answer) continue; 
        answer = answer.toString().replace(/\n/g, "<br>"); // Remplace les retours √† la ligne par <br>

        if (titreActuel.startsWith("nom de l'equipe fautive")) {
            // Fermeture des tables pr√©c√©dentes
            if (expulsionTable !== "") {
                message += expulsionTable + "</table><br><br>";
                // Les tables de d√©tails (s'il y en a) doivent √™tre ajout√©es apr√®s la derni√®re table d'expulsion
                // NOTE: Dans ce sc√©nario, nous allons g√©rer les d√©tails et infos compl√©mentaires √† la toute fin.
            }
            expulsionTable = `<table style="${styleTable}; page-break-inside: avoid;"><tr><th colspan="2" style="${styleHeaderCell}; ${styleTitleRow}">EXPULSION #${expulsionIndex}</th></tr><tr><td style="${styleCell40}"><b>${question}</b></td><td style="${styleCell}">${answer}</td></tr>`;
            expulsionIndex++;
            continue;
        }
        
        if (titreActuel.startsWith("codes")) {
            let tableau = separerEnTableau(answer);
            let htmlCodes = "<ul style='margin:0; padding-left:20px;'>";
            tableau.forEach(code => { htmlCodes += `<li>${code}</li>`; });
            htmlCodes += "</ul>";
            expulsionTable += `<tr><td style="${styleCell25}"><b>${question}</b></td><td style="${styleCell}">${htmlCodes}</td></tr>`;
            continue;
        }

        // Ces blocs sont maintenant g√©r√©s √† la fin, car ils sont uniques et globaux dans le formulaire HTML
        if (titreActuel.startsWith("details concernant") || titreActuel.startsWith("informations complementaires")) {
            continue;
        }

        // Ajoute les autres champs √† la table d'expulsion courante
        expulsionTable += `<tr><td style="${styleCell25}"><b>${question}</b></td><td style="${styleCell}">${answer}</td></tr>`;
    }

    // Fermeture de la derni√®re table d'expulsion
    if (expulsionTable !== "") message += expulsionTable + "</table><br><br>";

    // --- Ajout des d√©tails et informations compl√©mentaires (blocs globaux) ---
    
    // 1. D√©tails concernant les expulsions (Global)
    const detailsGlobal = getAnswerToQuestion("D√©tails concernant les expulsions", customData);
    if (detailsGlobal !== "N/A") {
        detailsTable += `<table style="${styleTable}; page-break-inside: avoid;">
            <tr><th colspan="2" style="${styleHeaderCell}; ${styleTitleRow}">
                <b>D√©tails concernant les expulsions</b>
            </th></tr>
            <tr><td colspan="2" style="${styleCell}">${detailsGlobal.replace(/\n/g, "<br>")}</td></tr>
        </table><br>`;
    }
    
    // 2. Informations compl√©mentaires (Global)
    const infosComplementaires = getAnswerToQuestion("Informations compl√©mentaires", customData);
    const avertissement = getAnswerToQuestion("avertissement avant d‚Äô√™tre expuls√©", customData);
    const duree = getAnswerToQuestion("longue dur√©e", customData);
    const environs = getAnswerToQuestion("quitt√© les environs", customData);
    
    const desc = `
        <ul style='list-style-type: none; margin: 0; padding: 0;'>
            <li>Le participant a-t-il re√ßu un avertissement avant d‚Äô√™tre expuls√©‚Äâ? <b>${avertissement}</b></li>
            <li>La situation √©tait-elle d‚Äôune longue dur√©e‚Äâ? <b>${duree}</b></li>
            <li>Une fois le terrain quitt√© par le participant, a-t-il quitt√© les environs du terrain et est-il rest√© invisible‚Äâ? <b>${environs}</b></li>
        </ul>
    `;
    
    if (infosComplementaires !== "N/A" || avertissement !== "N/A" || duree !== "N/A" || environs !== "N/A") {
        detailsTable += `<table style="${styleTable}; page-break-inside: avoid;">
            <tr><th colspan="2" style="${styleHeaderCell}; ${styleTitleRow}">
                <b>Informations compl√©mentaires</b>
            </th></tr>
            <tr><td colspan="2" style="${styleCell}">
                ${desc}
                <hr style="border: 0; border-top: 1px solid #ddd; margin: 10px 0;">
                <p style="margin: 0;">${infosComplementaires.replace(/\n/g, "<br>")}</p>
            </td></tr>
        </table><br><br>`;
    }

    message += detailsTable;
    message += `</div>`;

    // Le HTML final est envelopp√© dans une structure de document compl√®te pour √™tre utilisable
    const finalHTML = `
        <!doctype html>
        <html lang="fr">
        <head>
        <meta charset="UTF-8">
        <title>Rapport d'Expulsion - Match # ${numeroMatch}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
            .content-wrapper { max-width: 900px; margin: 20px auto; padding: 15px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: white; }
            /* Styles pour l'impression */
            @media print {
                .content-wrapper { box-shadow: none; border: none; }
                body { background-color: white; }
                /* Assurer la coupure de page propre pour les tableaux */
                table { page-break-inside: auto !important; }
                tr { page-break-inside: avoid !important; page-break-after: auto !important; }
                thead { display: table-header-group !important; }
                tfoot { display: table-footer-group !important; }
            }
        </style>
        </head>
        <body>
            <div class="content-wrapper">
                ${message}
                <p style="text-align:center; font-size:12px; color:#999; margin-top:30px;">
                    Rapport g√©n√©r√© le ${journee}.
                </p>
            </div>
        </body>
        </html>
    `;
    
    return finalHTML;
}

/**
 * Fonction principale appel√©e apr√®s validation pour g√©n√©rer et afficher le rapport.
 */
function generateAndDisplayReport() {
    try {
        const jsonDebug = generateDebugJSON();               // ton objet
		const customData = transformDebugJSONToCustomData(jsonDebug); // tableau {question, reponse}
		const htmlContent = genererRapportExpulsion(customData);
		
			
		envoyerRapportParEmail(customData);
	  //  convertirenPDF(customData);
		
		
        // Ouvre le HTML dans une nouvelle fen√™tre/onglet pour visualiser le rapport
        const newWindow = window.open();
        newWindow.document.write(htmlContent);
        newWindow.document.close();
        
        alert('Rapport HTML g√©n√©r√© avec succ√®s dans une nouvelle fen√™tre.');

    } catch (e) {
        console.error("Erreur lors de la g√©n√©ration du rapport HTML:", e);
        alert("Erreur lors de la g√©n√©ration du rapport HTML. D√©tails dans la console.");
    }
}

	
	/**
 * Met √† jour le contenu du <datalist> principal avec les options fournies.
 * @param {Array<string>} dataArray - Le tableau des √©quipes disponibles.
 */
function populateEquipesDatalist(dataArray) {
    const datalist = document.getElementById('equipesDataList');
    
    // Vider les options existantes
    datalist.innerHTML = ''; 

    if (dataArray && dataArray.length > 0) {
        dataArray.forEach(teamName => {
            const option = document.createElement('option');
            option.value = teamName; 
            datalist.appendChild(option);
        });
    }
    
    // Stoker les √©quipes disponibles dans une variable globale pour l'exclusion
    window.allAvailableTeams = dataArray || []; 
}
	
	
/**
 * G√®re l'exclusion: si une √©quipe est s√©lectionn√©e comme locale, elle n'est 
 * plus disponible pour visiteur, et vice-versa.
 */
function updateEquipeOptions(sourceInputId) {
    const localInput = document.getElementById('equipeLocale');
    const visiteurInput = document.getElementById('equipeVisiteur');

    const datalist = document.getElementById('equipesDataList');
    
    // Obtenir les valeurs courantes
    const selectedLocal = localInput.value.trim();
    const selectedVisiteur = visiteurInput.value.trim();
    
    // Vider et reconstruire le datalist
    datalist.innerHTML = '';
    
    if (window.allAvailableTeams && window.allAvailableTeams.length > 0) {
        window.allAvailableTeams.forEach(teamName => {
            const option = document.createElement('option');
            option.value = teamName;
            
            // Logique d'exclusion
            if (
                (sourceInputId === 'equipeLocale' && teamName === selectedVisiteur && teamName !== selectedLocal) ||
                (sourceInputId === 'equipeVisiteur' && teamName === selectedLocal && teamName !== selectedVisiteur)
            ) {
                // Si l'√©quipe est l'autre √©quipe d√©j√† s√©lectionn√©e, nous ne l'ajoutons pas √† la liste d'options
                // MAIS si la valeur en cours (selectedLocal ou selectedVisiteur) est celle de l'autre √©quipe, on la garde.
                // Le datalist est simplement l'ensemble de TOUTES les options possibles.
                // C'est le navigateur qui g√®re l'affichage des options en fonction de la saisie.
                // La meilleure approche est de populer le datalist avec TOUTES les options, 
                // et la logique de validation/s√©lection doit pr√©venir la double-saisie.
                
                // Cependant, pour simuler l'exclusion visuelle, on peut utiliser le datalist pour l'√©quipe qui n'est PAS en cours d'√©dition.
                
                // SOLUTION SIMPLIFI√âE : Remplissons TOUJOURS le datalist avec TOUTES les options
                // et ajoutons un √©couteur sur le blur/change pour alerter l'utilisateur si les deux sont identiques.
            }
            
            // Reconstruire la liste avec TOUTES les √©quipes disponibles
            datalist.appendChild(option);
        });
    }
    
    // Logique de validation d'exclusion (√† ajouter sur les √©v√©nements 'change' ou 'blur')
    if (selectedLocal && selectedVisiteur && selectedLocal === selectedVisiteur) {
        // Alerter ou g√©rer l'erreur ici (par exemple, vider l'un des champs ou afficher une erreur)
        const errorElement = document.querySelector(`#${sourceInputId} + .error`);
        if (errorElement) {
             errorElement.textContent = "L'√©quipe locale et visiteur ne peuvent pas √™tre les m√™mes.";
        }
        // Pour l'instant, on laisse l'utilisateur saisir, la validation finale s'occupera de bloquer l'envoi.
    } else {
        // Nettoyer le message d'erreur
        document.querySelector('#equipeLocale + .error').textContent = '';
        document.querySelector('#equipeVisiteur + .error').textContent = '';
    }
}
	
document.getElementById('equipeLocale').addEventListener('change', () => {
    updateEquipeOptions('equipeLocale');
});

document.getElementById('equipeVisiteur').addEventListener('change', () => {
    updateEquipeOptions('equipeVisiteur');
});

// Vous pouvez √©galement utiliser 'blur' pour une v√©rification imm√©diate apr√®s la saisie
document.getElementById('equipeLocale').addEventListener('blur', () => {
    updateEquipeOptions('equipeLocale');
});

document.getElementById('equipeVisiteur').addEventListener('blur', () => {
    updateEquipeOptions('equipeVisiteur');
});
	
// -------------------------------------------------------------
// SECTION: CODE EXISTANT DU FORMULAIRE (Fonctionnalit√©s et initialisation)
// -------------------------------------------------------------

function createSafeCodeKey(codeName) {
    // Remplace les espaces, tirets et autres caract√®res sp√©ciaux (sauf les points) par des underscores.
    return codeName.replace(/[^a-zA-Z0-9.]+/g, '_').trim();
}


async function init() {
    setupValidation();
    
    // 1. D√©marrer les deux requ√™tes en parall√®le SANS AWAIT
    // Chaque requ√™te est envelopp√©e dans une promesse pour g√©rer son propre parsing JSON et ses erreurs.
  /*  const regionsPromise = fetch(regionUrl)
        .then(res => res.ok ? res.json() : Promise.reject(new Error(`HTTP R√©gions ${res.status}`)))
        .catch(err => {
            console.warn("Impossible de r√©cup√©rer les r√©gions:", err);
            return {}; // Retourne un objet vide pour ne pas bloquer Promise.all
        });
	*/
    const regionsPromise = await chargerDonneesDepuisGitHub(regionUrl);
	
	const codesPromise = await chargerDonneesDepuisGitHub(codesUrl);
	
   /* const codesPromise = fetch(codesUrl)
        .then(resCodes => resCodes.ok ? resCodes.json() : Promise.reject(new Error(`HTTP Codes ${resCodes.status}`)))
        // Extraction de la cl√© 'Codes' et gestion de l'√©chec de parsing/fetch
        .then(codeData => codeData.Codes || {})
        .catch(err => {
            console.error("√âCHEC TOTAL du fetch des codes:", err);
            return {}; // Retourne un objet vide pour ne pas bloquer Promise.all
        });
*/
    // 2. Attendre que les deux promesses soient compl√©t√©es (la dur√©e sera celle du fetch le plus lent)
    const [regionsResult, codesResult] = await Promise.all([regionsPromise, codesPromise]);

    // 3. Affecter les r√©sultats aux variables globales
    // MODIFICATION: On prend directement la sous-cl√© "Regions" pour commencer l'it√©ration au bon niveau
    jsonRegions = regionsResult.Regions || {};
    jsonCodes = codesResult;

    // 4. Mise √† jour de l'UI (utilise le r√©sultat de jsonRegions qui est maintenant RIVE-SUD/RICHELIEU-YAMASKA)
    const regionSelect = document.getElementById("regionSelect");
    regionSelect.innerHTML = "<option value=''>-- S√©lectionner une r√©gion --</option>";
    Object.keys(jsonRegions).forEach(region=>{
        let opt = document.createElement("option");
        opt.value = region;
        opt.textContent = region;
        regionSelect.appendChild(opt);
    });

    // 5. Setup des chips d'expulsion apr√®s chargement des codes
    setupExpulsionChips(); 
} 
    
    
// ---------------- Gestion s√©lections dynamiques ----------------
document.getElementById("regionSelect").addEventListener("change", e => {
    const ligueSelect = document.getElementById("ligueSelect");
    const catSelect = document.getElementById("categorieSelect");
    const classeSelect = document.getElementById("classeSelect");
    ligueSelect.innerHTML = "<option value=''>-- S√©lectionner une ligue --</option>";
    catSelect.innerHTML = "<option value=''>-- S√©lectionner une cat√©gorie --</option>";
    classeSelect.innerHTML = "<option value=''>-- S√©lectionner une classe --</option>";
    destinatairesDiv.textContent = "";
    
    const region = e.target.value;
    
    if(!region) return;
    if(!jsonRegions[region]) return;
	 baseEmails = jsonRegions[region]._BaseEmails || [];
    
    // FILTRAGE: On filtre les cl√©s qui commencent par '_' (i.e., _BaseEmails)
    Object.keys(jsonRegions[region]).forEach(key=>{
        if (key.charAt(0) !== '_') {
            let opt = document.createElement("option"); 
            opt.value=key; 
            opt.textContent=key;
            ligueSelect.appendChild(opt);
        }
    });
});

document.getElementById("ligueSelect").addEventListener("change", e => {
    const region = document.getElementById("regionSelect").value;
    const ligue = e.target.value;
    const catSelect = document.getElementById("categorieSelect");
    const classeSelect = document.getElementById("classeSelect");
    catSelect.innerHTML = "<option value=''>-- S√©lectionner une cat√©gorie --</option>";
    classeSelect.innerHTML = "<option value=''>-- S√©lectionner une classe --</option>";
    destinatairesDiv.textContent = "";
    if(!ligue) return;
    
    // currentLigueData contient les cat√©gories/classes (ex: 9U A, Senior BB)
    currentLigueData = jsonRegions[region][ligue] || {};
    
    const categories = {};
    // S'assurer que les cl√©s comme _BaseEmails ne sont pas trait√©es comme des cat√©gories
    Object.keys(currentLigueData).forEach(key => {
        if (key.charAt(0) === '_') return;
        
        const parts = key.split(" ");
        const cat = parts[0];
        const cls = parts.slice(1).join(" ");
        if(!categories[cat]) categories[cat] = [];
        if(!categories[cat].includes(cls)) categories[cat].push(cls);
    });
    
    Object.keys(categories).forEach(cat => {
        let opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
    });
    catSelect.dataset.classes = JSON.stringify(categories);
    // LOGIQUE CORRIG√âE POUR L'AUTOFULL
    if(Object.keys(categories).length === 1){ 
        const onlyCat = Object.keys(categories)[0];
        catSelect.value = onlyCat;
        clearFieldError(catSelect);
        catSelect.dispatchEvent(new Event("change"));
        const classesForCat = categories[onlyCat];
        if(classesForCat.length === 1){
            const onlyClasse = classesForCat[0];
            classeSelect.value = onlyClasse;
            clearFieldError(classeSelect);
            classeSelect.dispatchEvent(new Event("change"));
        }
    }
});

document.getElementById("categorieSelect").addEventListener("change", e=>{
    const classes = JSON.parse(e.target.dataset.classes || "{}");
    const classeSelect = document.getElementById("classeSelect");
    classeSelect.innerHTML = "<option value=''>-- S√©lectionner une classe --</option>";
    const cat = e.target.value;
    if(!cat) return;
    classes[cat].forEach(cls=>{
        let opt = document.createElement("option"); opt.value=cls; opt.textContent=cls;
        classeSelect.appendChild(opt);
    });
});

document.getElementById("classeSelect").addEventListener("change", e=>{
    // ... (votre code existant pour les emails) ...
    const region = document.getElementById("regionSelect").value; 
    const cat = document.getElementById("categorieSelect").value;
    const cls = e.target.value;
    
	 // ---------------- NOUVEAU : R√©initialisation des champs √âquipe ----------------
    document.getElementById('equipeLocale').value = '';
    document.getElementById('equipeVisiteur').value = '';
    
    // Nettoyer les messages d'erreur au cas o√π une erreur d'√©quipe dupliqu√©e √©tait affich√©e
    document.querySelector('#equipeLocale + .error').textContent = '';
    document.querySelector('#equipeVisiteur + .error').textContent = '';
    // ---------------- FIN NOUVEAU ----------------
    // ... (code pour emails de base et sp√©cifiques) ...

    const selectedLevelData = currentLigueData[`${cat} ${cls}`];
    const specificEmails = (selectedLevelData && selectedLevelData.EmailsSpecifiques) || [];
    
    // ‚¨áÔ∏è NOUVELLE LOGIQUE POUR LES √âQUIPES ‚¨áÔ∏è
    const availableTeams = (selectedLevelData && selectedLevelData.Equipes) || [];
    populateEquipesDatalist(availableTeams);
	
    // 2. Concat√©ner les deux listes d'emails
    const allEmails = [...baseEmails, ...specificEmails];

    // 3. Mise √† jour de destinatairesDiv avec la liste compl√®te
    destinatairesDiv.textContent = allEmails.join(", ");
});
	
// ---------------- Gestion Arbitre Rapport (inchang√©) ----------------
function updateArbitreRapport() {
¬† ¬† const marbre = document.getElementById("arbitreMarbre").value.trim();
¬† ¬† const buts = document.getElementById("arbitreButs").value.trim();
¬† ¬† const arbitreRapportSelect = document.getElementById("arbitreRapport");

¬† ¬† const currentValue = arbitreRapportSelect.value;
¬† ¬† arbitreRapportSelect.innerHTML = "<option value=''>-- S√©lectionner un arbitre --</option>";

¬† ¬† const options = [];
¬† ¬† if (marbre) options.push(marbre);
¬† ¬† if (buts && buts !== marbre) options.push(buts);¬†

¬† ¬† options.forEach(optValue => {
¬† ¬† ¬† ¬† const opt = document.createElement("option");
¬† ¬† ¬† ¬† opt.value = optValue;
¬† ¬† ¬† ¬† opt.textContent = optValue;
¬† ¬† ¬† ¬† arbitreRapportSelect.appendChild(opt);
¬† ¬† });

¬† ¬† arbitreRapportSelect.disabled = !(marbre && buts);

¬† ¬† if (options.includes(currentValue)) {
¬† ¬† ¬† ¬† arbitreRapportSelect.value = currentValue;
¬† ¬† }
}
document.getElementById("arbitreMarbre").addEventListener("input", updateArbitreRapport);
document.getElementById("arbitreButs").addEventListener("input", updateArbitreRapport);

// --------------- Validation personnalis√©e (inchang√©) ---------------
function setFieldError(field, message) {
¬† ¬† if(!field) return;
¬† ¬† field.classList.add('input-error');
¬† ¬† let container = null;
¬† ¬† let ancestor = field.parentElement;
¬† ¬† for(let i=0;i<6 && ancestor; i++){
¬† ¬† ¬† ¬† if(ancestor.querySelector && ancestor.querySelector('.error')){ container = ancestor; break; }
¬† ¬† ¬† ¬† ancestor = ancestor.parentElement;
¬† ¬† }
¬† ¬† if(!container) container = field.parentElement || field;
¬† ¬† if(container && container.classList) container.classList.add('field-error');
¬† ¬† const err = container ? container.querySelector('.error') : null;
¬† ¬† if(err && message) { err.textContent = message; }
}

function clearFieldError(field) {
¬† ¬† if(!field) return;
¬† ¬† field.classList.remove('input-error');
¬† ¬† let ancestor = field.parentElement;
¬† ¬† for(let i=0;i<8 && ancestor; i++){
¬† ¬† ¬† ¬† if(ancestor.classList && ancestor.classList.contains('field-error')) ancestor.classList.remove('field-error');
¬† ¬† ¬† ¬† ancestor = ancestor.parentElement;
¬† ¬† }
¬† ¬† let container = field.parentElement;
¬† ¬† for(let i=0;i<6 && container; i++){
¬† ¬† ¬† ¬† const err = container.querySelector ? container.querySelector('.error') : null;
¬† ¬† ¬† ¬† if(err){¬†
¬† ¬† ¬† ¬† ¬† ¬† err.textContent = '';¬†
¬† ¬† ¬† ¬† ¬† ¬† break;¬†
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† container = container.parentElement;
¬† ¬† }
}

function setupValidation(){
    const form = document.getElementById('rapportForm');
    
    // üõë AJOUT pour le nettoyage des erreurs en temps r√©el
    // √âcoute des √©v√©nements 'input' (pour saisie clavier) et 'change' (pour select/date/imask)
    form.addEventListener('input', function(e) {
        if (e.target.classList.contains('input-error')) {
            clearFieldError(e.target);
        }
    });

    form.addEventListener('change', function(e) {
        if (e.target.classList.contains('input-error')) {
            clearFieldError(e.target);
        }
    });
    // --- FIN AJOUT NETTOYAGE EN TEMPS R√âEL ---
    
    // Soumission du formulaire
    form.addEventListener('submit', function(e){
        e.preventDefault();
        
        // üõë AJOUT CL√â: Nettoyage de TOUS les indicateurs d'erreurs existants
        document.querySelectorAll('.input-error, .field-error').forEach(el => el.classList.remove('input-error', 'field-error'));
        document.querySelectorAll('.error').forEach(el => el.textContent = '');
        // Nettoyage sp√©cifique pour les erreurs de codes d'expulsion (si vous aviez une erreur pr√©c√©demment signal√©e)
        document.querySelectorAll('.error-codes-validation').forEach(el => el.remove()); 
        
        // Assurez-vous que les donn√©es de l'onglet actif sont sauvegard√©es avant la validation
        serializeCurrentExpulsion(); 
        
        let valid = true;
        const requiredFields = Array.from(form.querySelectorAll('[required]')).filter(f => !f.disabled);

        requiredFields.forEach(field=>{
            // Note: clearFieldError(field) n'est plus n√©cessaire ici car on a tout nettoy√© au d√©but
            const val = String(field.value ?? '').trim();
            let shouldSignalError = false;  
            let errorMessage = '';         

            if (val === '') {
                shouldSignalError = true;  
                errorMessage = 'Ce champ est requis.'; 
            } else if (field.type === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(val)) {
                    shouldSignalError = true;
                    errorMessage = 'Format courriel invalide'; 
                }
            } else if (field.id === 'telephone') {
                if (val.replace(/\D/g, '').length !== 10) { 
                    shouldSignalError = true;
                    errorMessage = 'Num√©ro de t√©l√©phone incomplet (doit √™tre (000) 000-0000)';
                }
            }
            
            if (shouldSignalError) { 
                setFieldError(field, errorMessage); 
                valid = false;
            }
        });

        // üõë NOUVELLE LOGIQUE DE VALIDATION POUR LES CODES D'EXPULSION
        const expulsions = generateDebugJSON().expulsions;
        
        expulsions.forEach(exp => {
            if (exp.joueur && exp.codes.length === 0) {
                const panel = document.getElementById(`expulsion-${exp.numero}`);
                const codesContainer = panel.querySelector(`#expulsion-${exp.numero}-codes`);
                
                if (codesContainer) {
                    let errorSpan = codesContainer.parentElement.querySelector('.error-codes-validation');
                    if (!errorSpan) {
                        errorSpan = document.createElement('span');
                        errorSpan.classList.add('error', 'error-codes-validation');
                        errorSpan.style.textAlign = 'center';
                        errorSpan.style.width = '100%';
                        codesContainer.parentElement.insertBefore(errorSpan, codesContainer);
                    }
                    errorSpan.textContent = 'S√©lectionnez au moins un code d\'expulsion.';
                    valid = false;
                }
            } else {
                 // S'assurer de retirer l'erreur si l'expulsion est valide
                 const panel = document.getElementById(`expulsion-${exp.numero}`);
                 const codesContainer = panel ? panel.querySelector(`#expulsion-${exp.numero}-codes`) : null;
                 if(codesContainer){
                     codesContainer.parentElement.querySelectorAll('.error-codes-validation').forEach(el => el.remove());
                 }
            }
        });
        // --- FIN NOUVELLE LOGIQUE ---

        if(valid){
            document.getElementById('debugOutput').textContent = JSON.stringify(generateDebugJSON(), null, 4);
            // üõë APPEL DE LA FONCTION DE G√âN√âRATION HTML
            generateAndDisplayReport(); 
        } else {
            document.getElementById('debugOutput').textContent = 'Formulaire invalide ‚Äî corrigez les champs en rouge.';
            alert('‚ö†Ô∏è Certains champs sont vides ou incomplets. Corrigez les champs en rouge.');
            const invalids = Array.from(form.querySelectorAll('.input-error, .error-codes-validation')).filter(f => !f.disabled);
            if(invalids.length){
                try{ invalids[0].focus(); }catch(err){}
                invalids[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    // ... (Le reste de la fonction reste inchang√©)
}

// ---------------- GESTION DE LA PERSISTANCE (CORRIG√âE avec s√©parateur unique) ----------------
/**
 * Sauvegarde les donn√©es de l'expulsion actuellement affich√©e dans la variable globale `expulsionsData`.
 * üõë Utilise le double pipe '||' comme s√©parateur.
 */
function serializeCurrentExpulsion() {
    const activePanel = document.querySelector("#expulsionsContainer .tab-content.active");
    if (!activePanel) return;
    
    // L'index est d√©duit de l'ID, ex: 'expulsion-1' -> 1
    const index = parseInt(activePanel.id.split('-')[1]);
    
    // R√©cup√®re le champ cach√©
    const codesInput = activePanel.querySelector('input[name^="expulsion"][name$="-codes"]');
    
    // üõë Calcule la liste des NOMS COMPLETS √† partir des chips s√©lectionn√©s
    const selectedChips = activePanel.querySelectorAll('.code-chip.selected');
    // Utilise CODE_SEPARATOR (||) pour joindre
    const currentCodesValue = Array.from(selectedChips).map(c => c.dataset.name).join(CODE_SEPARATOR);

    // Met √† jour le champ cach√© (contient la liste des noms complets)
    if (codesInput) {
        codesInput.value = currentCodesValue;
    }

    expulsionsData[index] = {
        equipe: activePanel.querySelector('select[name^="expulsion"][name$="-equipe"]')?.value || '',
        numero: activePanel.querySelector('input[name^="expulsion"][name$="-numero"]')?.value || '',
        nom: activePanel.querySelector('input[name^="expulsion"][name$="-nom"]')?.value || '',
        // ENREGISTREMENT CRITIQUE du nom complet des codes
        codes: currentCodesValue, 
    };
}

/**
 * Charge les donn√©es d'une expulsion dans les champs du panneau actif et met √† jour les chips.
 * üõë Utilise le double pipe '||' pour s√©parer.
 */
function loadExpulsionData(index, panel) {
    const data = expulsionsData[index] || {};
    
    // Remplir les champs
    const equipeSelect = panel.querySelector('select[name^="expulsion"][name$="-equipe"]');
    if (equipeSelect) equipeSelect.value = data.equipe || '';
    
    const numeroInput = panel.querySelector('input[name^="expulsion"][name$="-numero"]');
    if (numeroInput) numeroInput.value = data.numero || '';
    
    const nomInput = panel.querySelector('input[name^="expulsion"][name$="-nom"]');
    if (nomInput) nomInput.value = data.nom || '';
    
    // G√©rer la persistance des codes lors du chargement
    const codesInput = panel.querySelector('input[name^="expulsion"][name$="-codes"]');
    let selectedCodeNames;


    // üõë NOUVELLE LOGIQUE DE S√âLECTION PAR D√âFAUT
    if (!data.codes) {
        // Si aucune donn√©e n'est enregistr√©e pour cette expulsion, on s√©lectionne le d√©faut.
        selectedCodeNames = Array.from(panel.querySelectorAll('.code-chip'))
            .filter(c => c.dataset.name.startsWith("55.1 -")) // üõë FILTRAGE PAR "55.1"
            .map(c => c.dataset.name);
        
        // Mettre √† jour l'objet de persistance et le champ cach√© avec la s√©lection par d√©faut
        const defaultCodesValue = selectedCodeNames.join(CODE_SEPARATOR);

        if (codesInput) codesInput.value = defaultCodesValue;
        
        // Assurer que la persistence est √† jour pour la prochaine sauvegarde/rechargement
        expulsionsData[index] = {
            equipe: data.equipe || '',
            numero: data.numero || '',
            nom: data.nom || '',
            codes: defaultCodesValue, // Application de la s√©lection par d√©faut
        };
        
    } else {
        // Utiliser les codes enregistr√©s
        selectedCodeNames = (data.codes || '').split(CODE_SEPARATOR).filter(c => c);
        if (codesInput) codesInput.value = data.codes; // Le champ cach√© est mis √† jour
    }

    // Mettre √† jour l'affichage des chips bas√©s sur la liste (enregistr√©e ou par d√©faut)
    panel.querySelectorAll('.code-chip').forEach(chip => {
        // üõë Utilise l'attribut data-name (le nom complet) pour v√©rifier si le chip est s√©lectionn√©
        const isSelected = selectedCodeNames.includes(chip.dataset.name);
        chip.classList.toggle('selected', isSelected);
    });
}


// ---------------- GESTION DES EXPULSION// ----------------
function setupExpulsionChips(reset = false) {
    const chipsContainer = document.getElementById("chipsNbExp");
    const maxExpulsions = 6;
    
    if (reset) {
        expulsionsData = {}; // R√©initialiser les donn√©es
    }

    // Si les chips n'existent pas, les cr√©er
    if (chipsContainer.innerHTML === '') {
        for (let i = 1; i <= maxExpulsions; i++) {
            const chip = document.createElement("button"); // Utiliser <button> pour l'accessibilit√©
            chip.type = "button";
            chip.classList.add("chip");
            chip.dataset.value = i;
            chip.textContent = i;
            chipsContainer.appendChild(chip);
            
            chip.addEventListener("click", () => {
                // üõë 1. Avant de changer, sauvegarder l'√©tat de l'onglet pr√©c√©dent
                serializeCurrentExpulsion();

                // 2. Changer la s√©lection des chips
                document.querySelectorAll("#chipsNbExp .chip").forEach(c => c.classList.remove("selected"));
                chip.classList.add("selected");
                
                // 3. Reconstruire/Mettre √† jour la vue avec le nouveau nombre
                createExpulsionTabs(i);
            });
        }
    }

    // S√©lectionner et appeler '1' par d√©faut (ou lors d'un reset)
    // On r√©cup√®re le nombre d'expulsions pr√©c√©demment s√©lectionn√©
    const nbToSelect = reset ? 1 : (document.querySelector("#chipsNbExp .chip.selected") ? parseInt(document.querySelector("#chipsNbExp .chip.selected").dataset.value) : 1);

    document.querySelectorAll("#chipsNbExp .chip").forEach(c => c.classList.remove("selected"));
    const defaultChip = document.querySelector(`#chipsNbExp .chip[data-value='${nbToSelect}']`);
    if (defaultChip) {
        defaultChip.classList.add("selected");
        createExpulsionTabs(nbToSelect);
    }
}
/**
 * Cr√©e/met √† jour la structure des onglets d'expulsion (boutons et contenu).
 */
function createExpulsionTabs(nbExpulsions) {
    const tabsContainer = document.getElementById("expTabs");
    const expulsionsContainer = document.getElementById("expulsionsContainer");
    const maxExpulsions = 6;
    
    const equipeLocale = document.getElementById('equipeLocale')?.value.trim();
    const equipeVisiteur = document.getElementById('equipeVisiteur')?.value.trim();
    
    // 1. Pr√©parer les options d'√©quipe pour les selects
    let equipeOptions = `<option value="">-- S√©lectionner √©quipe --</option>`;
    
    if (equipeLocale) { equipeOptions += `<option value="${equipeLocale}">${equipeLocale}</option>`; }
    else { equipeOptions += `<option value="" disabled>Locale (√† remplir)</option>`; }
    
    if (equipeVisiteur) { equipeOptions += `<option value="${equipeVisiteur}">${equipeVisiteur}</option>`; }
    else { equipeOptions += `<option value="" disabled>Visiteur (√† remplir)</option>`; }


    // 2. G√©rer la visibilit√© des onglets et cr√©er/mettre √† jour les panneaux
    let firstVisiblePanel = null;
    let firstVisibleButton = null;
    
    // Trouver l'index de l'onglet qui √©tait actif avant la mise √† jour
    const activeTabIndex = document.querySelector("#expTabs button.active") ? parseInt(document.querySelector("#expTabs button.active").textContent.split(' ')[1]) : 1;

    // Vider les anciens boutons d'onglet avant de les recr√©er
    tabsContainer.innerHTML = '';¬†

    for (let i = 1; i <= maxExpulsions; i++) {
        const tabId = `expulsion-${i}`;
        let panel = document.getElementById(tabId);
        const isVisible = i <= nbExpulsions;

        if (isVisible) {
            // Cr√©er/mettre √† jour le panneau
            if (!panel) {
                panel = document.createElement("div");
                panel.id = tabId;
                panel.classList.add("tab-content");
                expulsionsContainer.appendChild(panel);¬†
                
                // Le contenu doit √™tre recr√©√© pour un nouveau panneau
                panel.innerHTML = `
                    <div class="expulsion-block">
                        <div class="exp-row">
                            <div class="exp-equipe">
                                <label>√âquipe fautive</label>
                                <select name="expulsion${i}-equipe" required tabindex="${20 + i}">
                                    ${equipeOptions}
                                </select>
                            </div>
                            <div class="exp-numero">
                                <label>Num√©ro</label>
                                <input type="number" name="expulsion${i}-numero" min="0" required tabindex="${20 + i + maxExpulsions}">
                            </div>
                            <div class="exp-nom">
                                <label>Nom de la personne fautive</label>
                                <input type="text" name="expulsion${i}-nom" required tabindex="${20 + i + (maxExpulsions * 2)}">
                            </div>
                        </div>
                        
                        <div class="panel-3d-detail" style="width: 100%; margin: 15px auto 0; padding: 15px;">
                            <h3 style="margin-top:0; font-size: 1.1em; text-align:center; width: 100%;">Codes d'expulsion (S√©lection multiple)</h3>
                            <input type="hidden" name="expulsion${i}-codes">
                            <div class="codes-container" id="expulsion-${i}-codes"></div>
                        </div>
                    </div>
                `;
                    // üõë CR√âATION INITIALE des chips avec les listeners
                createCodeChips(i, jsonCodes, panel);¬†

            } else {
                // Mise √† jour des options de l'√©quipe (sans perdre la s√©lection)
                const selectEquipe = panel.querySelector('select[name^="expulsion"][name$="-equipe"]');
                const currentValue = selectEquipe ? selectEquipe.value : '';
                if(selectEquipe) {
                    selectEquipe.innerHTML = equipeOptions;
                    selectEquipe.value = currentValue;¬†
                }
                    // üõë MISE √Ä JOUR des chips (pour s'assurer que les listeners sont l√† et que la structure est √† jour)
                createCodeChips(i, jsonCodes, panel);
            }
            
            // LOGIQUE D'ACTIVATION/D√âSACTIVATION DES CHAMPS
            const requiredFields = panel.querySelectorAll('[required]');
            const selectEquipeField = panel.querySelector('select[name^="expulsion"]');
            const toutesEquipesRemplies = equipeLocale && equipeVisiteur;
            const estDesactiveCarEquipeVide = !toutesEquipesRemplies;

            if (selectEquipeField) {
                selectEquipeField.disabled = estDesactiveCarEquipeVide || !isVisible;
            }
            requiredFields.forEach(field => {
                field.disabled = !isVisible || estDesactiveCarEquipeVide;
                if(!isVisible || estDesactiveCarEquipeVide) {
                    if (field.type === 'select-one' || field.type === 'text' || field.type === 'number') {
                        field.value = '';¬†
                    }
                    clearFieldError(field);¬†
                }
            });
            
            // Cr√©er le bouton d'onglet
            const tabBtn = document.createElement("button");
            tabBtn.type = "button";
            tabBtn.textContent = `Expulsion ${i}`;
            
            // √âv√©nement pour changer d'onglet
            tabBtn.addEventListener("click", () => {
                // üõë 1. Sauvegarder l'√©tat actuel AVANT de changer d'onglet
                serializeCurrentExpulsion();

                // 2. Changer d'onglet
                document.querySelectorAll("#expTabs button").forEach(btn => btn.classList.remove("active"));
                document.querySelectorAll("#expulsionsContainer .tab-content").forEach(p => p.classList.remove("active"));
                tabBtn.classList.add("active");
                panel.classList.add("active");
                
                // üõë 3. Charger les donn√©es du NOUVEL onglet
                loadExpulsionData(i, panel);
            });
            tabsContainer.appendChild(tabBtn);

            // Charger les donn√©es de persistance AVANT d'activer
            // loadExpulsionData(i, panel); // Fait plus bas apr√®s l'activation.
            
            if (!firstVisibleButton || i === activeTabIndex) firstVisibleButton = tabBtn;
            if (!firstVisiblePanel || i === activeTabIndex) firstVisiblePanel = panel;
            
        } else {
            // Masquer les panneaux en trop
            if (panel) panel.classList.remove("active");
            // Important: Effacer les donn√©es des onglets masqu√©s dans l'objet de persistance
            if (expulsionsData[i]) delete expulsionsData[i];¬†
            panel?.querySelectorAll('[required]').forEach(clearFieldError);
        }
    }
    
    // Masquer les panneaux qui ne sont plus visibles
    for(let i = nbExpulsions + 1; i <= maxExpulsions; i++){
        document.getElementById(`expulsion-${i}`)?.classList.remove('active');
    }

    // Activer l'onglet qui √©tait actif (ou le premier s'il n'existe plus)
    if (firstVisibleButton && firstVisiblePanel) {
        firstVisibleButton.classList.add("active");
        firstVisiblePanel.classList.add("active");
        // Recharger les donn√©es pour l'onglet qui devient actif (y compris la s√©lection par d√©faut)
        loadExpulsionData(parseInt(firstVisiblePanel.id.split('-')[1]), firstVisiblePanel);
    }
}

// Mise √† jour de la liste d'√©quipes et des onglets lors de la saisie
function updateEquipeSelectsOnInput() {
    // 1. R√©cup√©rer le nombre d'expulsions actuellement s√©lectionn√©
    const selectedChip = document.querySelector("#chipsNbExp .chip.selected");
    const nbExpulsions = selectedChip ? parseInt(selectedChip.dataset.value) : 1;¬†

    // 2. Sauvegarder l'√©tat de l'onglet actif (pour ne pas perdre les donn√©es actuelles)
    serializeCurrentExpulsion();¬†

    // 3. Mettre √† jour tous les onglets (qui vont restaurer les valeurs sauvegard√©es via loadExpulsionData)
    createExpulsionTabs(nbExpulsions);
}


// Cr√©e et g√®re les chips de codes pour une expulsion

function createCodeChips(expulsionIndex, codesData, panel) {
    const codesContainer = panel.querySelector(`#expulsion-${expulsionIndex}-codes`);
    if (!codesContainer) return;

    // R√©cup√©rer le champ cach√© existant ou le cr√©er si inexistant
    let hiddenInput = panel.querySelector(`input[name="expulsion${expulsionIndex}-codes"]`);
    if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `expulsion${expulsionIndex}-codes`;
        codesContainer.appendChild(hiddenInput); // Ajout en d√©but de conteneur
    }
    
    // Si les donn√©es sont vides, on affiche un message d'erreur
    if (Object.keys(codesData).length === 0) {
        codesContainer.innerHTML += '<span style="color: #D93025; font-weight: bold; text-align: center; display: block; width: 100%;">‚ö†Ô∏è Les codes d\'expulsion n\'ont pas pu √™tre charg√©s. V√©rifiez votre URL de source de donn√©es.</span>';
        return;
    }
    
    // Vider seulement les chips pour les recr√©er avec les listeners, en conservant le champ cach√©
    Array.from(codesContainer.children).filter(el => el.classList.contains('code-chip')).forEach(chip => chip.remove());
    
    // 3. G√©n√©ration des chips
    Object.entries(codesData).forEach(([codeName, codeDetails]) => {
        const chip = document.createElement("div");
        chip.classList.add("code-chip");
        // üõë Utilisation de deux attributs: data-code pour la cl√© s√©curis√©e et data-name pour le nom complet
        chip.dataset.code = createSafeCodeKey(codeName);
        chip.dataset.name = codeName;
        
        const tooltipText = codeDetails.Explications ? codeDetails.Explications.replace(/\r\n/g, '<br>') : 'Aucune explication fournie.';
        chip.innerHTML = `${codeName}<span class="tooltip">${tooltipText}</span>`;
        
        // √âcouteur pour la s√©lection multiple
        chip.addEventListener('click', () => {
            chip.classList.toggle('selected');
            
            // üõë Mise √† jour de la valeur du champ cach√© avec la liste des NOMS COMPLETS s√©par√©s par le CODE_SEPARATOR
            let currentSelections = Array.from(codesContainer.querySelectorAll('.code-chip.selected')).map(c => c.dataset.name);
            hiddenInput.value = currentSelections.join(CODE_SEPARATOR);
            
            // Sauvegarder imm√©diatement l'√©tat complet dans l'objet global pour persistance
            serializeCurrentExpulsion();¬†
            
            // üõë AJOUT pour retirer l'erreur si au moins une puce est s√©lectionn√©e
            // Ceci nettoie le message "S√©lectionnez au moins un code d'expulsion"
            if (currentSelections.length > 0) {
                 codesContainer.parentElement.querySelectorAll('.error-codes-validation').forEach(el => el.remove());
            }
        });
        
        codesContainer.appendChild(chip);
    });
}¬† ¬†¬†
			
async function envoyerRapportParEmail(data) {
  const emailUrl = "https://script.google.com/macros/s/AKfycbzptS_pTHRw9HERRy6ZjLKfkY25GTgOkHbJMaSi7h9wd2tFyiF0zKWaw9T-HoArXrrw/exec"; // ton URL
  const rapportHTML = genererRapportExpulsion(data);
  const adresseDeDestination = "ump_77@videotron.ca,ump_77@hotmail.com";

  const payload = {
    htmlContent: rapportHTML,
    destinatairesContainer: adresseDeDestination,
    sujetCourriel: ObjetCourriel // variable que tu as d√©j√†
  };

  try {
    const response = await fetch(emailUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    console.log("R√©sultat serveur:", result);
    if (result.success) {
      alert(`‚úÖ OK ‚Äî ${result.fileName}`);
      document.getElementById('rapportForm').reset();
    } else {
      alert(`‚ùå Erreur serveur: ${result.error}`);
    }
  } 
}


	
			
function generateDebugJSON() {
    // üõë Sauvegarder l‚Äô√©tat courant de l‚Äôexpulsion active
    serializeCurrentExpulsion();

    // R√©cup√©ration des valeurs "match"
    const match = {
        numero: document.getElementById("matchNumero")?.value.trim() || "",
       // üõë LIGNE MODIFI√âE: Remplace l'espace entre la date et l'heure par 'T'
        date: document.getElementById("matchDate")?.value.trim().replace('T', ' ') || "", 
        region: document.getElementById("regionSelect")?.value || "",
        ligue: document.getElementById("ligueSelect")?.value || "",
        categorie: document.getElementById("categorieSelect")?.value || "",
        classe: document.getElementById("classeSelect")?.value || "",
       // LIGNE CORRIG√âE: Utiliser l'ID 'details' au lieu de 'detailsExpulsions'
        details_expulsions: document.getElementById("details")?.value.trim() || "",
        // LIGNE CORRIG√âE: Utiliser l'ID 'infos_complementaires' au lieu de 'infosComplementaires'
        infos_complementaires: document.getElementById("infos_complementaires")?.value.trim() || "",
        id: "" // g√©n√©r√© apr√®s
    };

   ObjetCourriel = `(${match.region}) Rapport d'expulsion : Match # ${match.numero}`;



	// G√©n√©ration d‚Äôun ID unique bas√© sur date + ligue + num√©ro
    if (match.date && match.ligue && match.numero) {
        match.id = `${match.date.replace(/[: ]/g,"-")}_${match.ligue.toLowerCase().replace(/[^a-z0-9]+/g,"-")}_${match.numero}`;
    }

    // Section √©quipes
    const equipes = {
        locale: document.getElementById("equipeLocale")?.value.trim() || "",
        visiteur: document.getElementById("equipeVisiteur")?.value.trim() || "",
        terrain: document.getElementById("terrain")?.value.trim() || ""
    };

    // Section officiels
    const officiels = {
        marbre: document.getElementById("arbitreMarbre")?.value.trim() || "",
        buts: document.getElementById("arbitreButs")?.value.trim() || "",
        marqueur: document.getElementById("marqueur")?.value.trim() || "",
        rapport: document.getElementById("arbitreRapport")?.value.trim() || "",
        courriel: document.getElementById("courriel")?.value.trim() || "",
        telephone: document.getElementById("telephone")?.value.trim() || ""
    };

    // Section expulsions (tableau)
    const expulsions = [];
    for (let i = 1; i <= 6; i++) {
        const data = expulsionsData[i];
        if (data && (data.equipe || data.numero || data.nom || data.codes)) {
            expulsions.push({
                numero: i,
                equipe: data.equipe || "",
                chandail: data.numero || "",
                joueur: data.nom || "",
                codes: (data.codes || "").split(CODE_SEPARATOR).filter(c => c)
            });
        }
    }

   
	
	// Construction finale
    const result = {
        match,
        equipes,
        officiels,
        expulsions
    };
    
    // Affichage joli dans debugOutput
    document.getElementById("debugOutput").textContent = JSON.stringify(result, null, 4);

    return result; // optionnel si tu veux l'utiliser ailleurs
}

¬† ¬†¬†

// ---------------- INITIALISATION FINALE ----------------
 document.addEventListener("keydown", function(event) {
        
        // V√©rifie si la touche Ctrl (ou Cmd sur Mac) ET la touche Alt sont enfonc√©es
        const isCtrlAlt = (event.ctrlKey || event.metaKey) && event.altKey;
        
        // V√©rifie si la touche 'd' (D) est press√©e
        const isD = event.key.toLowerCase() === 'd' || event.keyCode === 68;

        // Si le raccourci Ctrl+Alt+D est press√©
        if (isCtrlAlt && isD) {
            // Emp√™che l'action par d√©faut du navigateur (par exemple, ouvrir un menu)
            event.preventDefault(); 

            const destContainer = document.getElementById('destinatairesContainer');
            const debugContainer = document.getElementById('debugContainer');

            // D√©finit la fonction de bascule de visibilit√©
            const toggleVisibility = (element) => {
                if (element) {
                    // Si l'√©l√©ment est masqu√© (display: 'none'), on l'affiche
                    if (element.style.display === 'none') {
                        // R√©initialise le style √† la valeur par d√©faut pour une div, qui est 'block'
                        element.style.display = ''; 
                    } else {
                        // Sinon, on le masque
                        element.style.display = 'none';
                    }
                }
            };

            // Applique la bascule aux deux conteneurs
            toggleVisibility(destContainer);
            toggleVisibility(debugContainer);
        }
    });	
	
	
document.addEventListener("DOMContentLoaded", () => {
    // Les √©couteurs pour la mise √† jour des √©quipes
    document.getElementById("equipeLocale")?.addEventListener("input", updateEquipeSelectsOnInput);
    document.getElementById("equipeVisiteur")?.addEventListener("input", updateEquipeSelectsOnInput);

    const phoneInput = document.getElementById('telephone');
    if (phoneInput) {
        // IMask pour le t√©l√©phone (code existant)
        IMask(phoneInput, {
            mask: '(000) 000-0000'
        });
    }

    // ----------------------------------------------------
    // INITIALISATION FLATICKR + IMASK POUR LA DATE/HEURE
    // ----------------------------------------------------
    const matchDateInput = document.getElementById("matchDate");
    if (matchDateInput) {
        // 1. Initialisation de Flatpickr et r√©cup√©ration de l'instance
        const fp = flatpickr(matchDateInput, {
            enableTime: true,           // Active le s√©lecteur d'heure
            time_24hr: true,            // Format 24 heures
            locale: "fr",               // Localisation fran√ßaise
            
            // Format pour la soumission (NE PAS CHANGER : YYYY-MM-DD HH:MM)
            dateFormat: "Y-m-d H:i",    
            
            // Format d'affichage pour l'utilisateur (AAAA-MM-JJ HH:MM)
            altInput: true,             
            altFormat: "Y-m-d H:i",     
            
            // Permet la saisie manuelle
            allowInput: true, 
        });

        // 2. Initialisation d'IMask sur le champ VISIBLE (fp.altInput)
        if (fp.altInput) {
            // D√©finit le placeholder HTML pour le guide visuel (AAAA-MM-JJ HH:MM)
            fp.altInput.placeholder = 'AAAA-MM-JJ HH:MM';
            
            // Applique le masque pour les chiffres (0)
            IMask(fp.altInput, {
                mask: '0000-00-00 00:00', // Le masque de saisie des chiffres
                lazy: true,              // Le masque est visible d√®s le d√©but
                // Le placeholderChar n'est pas n√©cessaire car le placeholder HTML est utilis√©
            });
        }
    }
    // ----------------------------------------------------
    
    // Lancement de l'initialisation (qui inclut le fetch et le setupExpulsionChips)
    init(); 
});
	</script>
</body>
</html>